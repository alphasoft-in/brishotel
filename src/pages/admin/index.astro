---
import Layout from "../../layouts/Layout.astro";
import { db } from "../../lib/db";
import { getRoomImages } from "../../lib/images";
import { verifySession } from "../../lib/auth";

export const prerender = false;

// Protección de Ruta
const session = Astro.cookies.get("admin_session")?.value;
if (!verifySession(session)) {
    return Astro.redirect("/login");
}

// Obtener datos iniciales
const rooms = await db.getRoomCategories();
const rawTransactions = await db.getTransactions();
const complaints = await db.getComplaints();

// Filtrar transacciones para el historial (Ocultar FALLIDO y CANCELADO/ANULADO)
const transactions = rawTransactions.filter(
    (tx) => tx.status !== "FALLIDO" && tx.status !== "CANCELADO",
);

// Cálculo de KPIs
const successfulTx = transactions.filter((tx) => tx.status === "EXITOSO");
const totalRevenue = successfulTx.reduce((acc, curr) => acc + curr.amount, 0);

const alertsList = transactions.filter(
    (tx) => tx.status === "PENDIENTE" || tx.status === "INICIADO",
);
const pendingTxCount = alertsList.length;

const pendingRevenue = alertsList.reduce((acc, curr) => acc + curr.amount, 0);

// Sincronización (Last Sync Info)
const lastSyncDate = new Date().toLocaleTimeString("es-PE", {
    timeZone: "America/Lima",
});

const pendingComplaints = complaints.filter((c) => c.status === "PENDIENTE");
const pendingComplaintsCount = pendingComplaints.length;

// Ocupación Total (Suma de unidades ocupadas de todas las categorías)
const occupancyCount = rooms.reduce((acc, cat) => {
    return acc + (cat.counts.ocupado + cat.counts.reservado);
}, 0);
const totalUnitsCount = rooms.reduce((acc, cat) => acc + cat.units.length, 0);

// Configuración de Estados (System Precision)
const statusConfig = {
    libre: {
        label: "Disponible",
        color: "text-emerald-600",
        bg: "bg-emerald-50",
        border: "border-emerald-100/50",
    },
    ocupado: {
        label: "En Uso",
        color: "text-rose-600",
        bg: "bg-rose-50",
        border: "border-rose-100/50",
    },
    limpieza: {
        label: "Limpieza",
        color: "text-blue-600",
        bg: "bg-blue-50",
        border: "border-blue-100/50",
    },
    reservado: {
        label: "Reservado",
        color: "text-indigo-600",
        bg: "bg-indigo-50",
        border: "border-indigo-100/50",
    },
    mantenimiento: {
        label: "Servicio",
        color: "text-amber-600",
        bg: "bg-amber-50",
        border: "border-amber-100/50",
    },
};
---

<Layout title="Bris Admin | Optimized Management">
    <div
        class="min-h-screen bg-[#FDFBF9] font-inter selection:bg-[#00a19b]/10 text-slate-900 antialiased"
    >
        <!-- Navbar Superior Compacta -->
        <!-- Navbar Superior Premium -->
        <nav
            class="fixed top-0 inset-x-0 h-16 bg-white/80 backdrop-blur-md border-b border-slate-200/50 z-[100] px-6 flex items-center justify-between transition-all duration-300"
        >
            <div class="flex items-center gap-8">
                <div class="flex items-center gap-3">
                    <div
                        class="w-8 h-8 bg-slate-900 rounded-lg flex items-center justify-center text-white font-black text-xs shadow-lg shadow-slate-900/20"
                    >
                        B
                    </div>
                    <div class="flex flex-col justify-center">
                        <h1
                            class="font-bold text-sm tracking-tight text-slate-900 leading-none"
                        >
                            Bris Management
                        </h1>
                        <span
                            class="text-[10px] font-medium text-slate-400 tracking-wide uppercase mt-0.5"
                            >Admin Panel</span
                        >
                    </div>
                </div>
            </div>

            <div class="flex items-center gap-4">
                <div
                    class="hidden md:flex items-center gap-2 px-3 py-1.5 bg-slate-100/50 rounded-full border border-slate-200/50"
                >
                    <div
                        class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"
                    >
                    </div>
                    <span class="text-[11px] font-semibold text-slate-600"
                        >Sistema Activo</span
                    >
                </div>

                <div class="h-6 w-px bg-slate-200 mx-2"></div>

                <button
                    id="logout-btn"
                    class="group flex items-center gap-2 px-3 py-2 text-slate-500 hover:text-rose-600 hover:bg-rose-50 rounded-lg transition-all duration-200"
                    title="Cerrar Sesión"
                >
                    <span
                        class="text-xs font-semibold hidden md:block group-hover:translate-x-0.5 transition-transform"
                        >Salir</span
                    >
                    <svg
                        xmlns="http://www.w3.org/2000/svg"
                        class="w-4 h-4"
                        fill="none"
                        viewBox="0 0 24 24"
                        stroke="currentColor"
                        stroke-width="2"
                        ><path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"
                        ></path></svg
                    >
                </button>
            </div>
        </nav>

        <main class="pt-24 pb-16 px-6 max-w-[1400px] mx-auto">
            <!-- Dashboard KPIs -->
            <div
                class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 mb-8"
            >
                <div
                    class="bg-white border border-slate-200 p-5 rounded-lg shadow-sm"
                >
                    <p
                        class="text-[11px] font-bold text-slate-400 uppercase tracking-widest mb-1.5"
                    >
                        Ingresos Totales (S/)
                    </p>
                    <h3
                        class="text-3xl font-bold text-slate-900 tracking-tight"
                    >
                        {totalRevenue.toFixed(2)}
                    </h3>
                    <p class="text-[11px] font-bold text-[#00a19b] mt-2">
                        + {pendingRevenue.toFixed(2)} por confirmar
                    </p>
                </div>
                <div
                    class="bg-white border border-slate-200 p-5 rounded-lg shadow-sm"
                >
                    <p
                        class="text-[11px] font-bold text-slate-400 uppercase tracking-widest mb-1.5"
                    >
                        Ocupación Actual
                    </p>
                    <h3
                        class="text-3xl font-bold text-slate-900 tracking-tight"
                    >
                        {occupancyCount} / {totalUnitsCount}
                    </h3>
                </div>
                <div
                    class="bg-white border border-slate-200 p-5 rounded-lg shadow-sm"
                >
                    <p
                        class="text-[11px] font-bold text-slate-400 uppercase tracking-widest mb-1.5"
                    >
                        Disponibles
                    </p>
                    <h3
                        class="text-3xl font-bold text-emerald-600 tracking-tight"
                    >
                        {rooms.reduce((acc, cat) => acc + cat.counts.libre, 0)}
                    </h3>
                </div>
                <div
                    class="bg-white border border-slate-200 p-5 rounded-lg shadow-sm border-rose-100"
                >
                    <p
                        class="text-[11px] font-bold text-slate-400 uppercase tracking-widest mb-1.5"
                    >
                        Alertas Pagos
                    </p>
                    <h3 class="text-3xl font-bold text-rose-500 tracking-tight">
                        {pendingTxCount}
                    </h3>
                </div>
                <div
                    class="bg-white border border-slate-200 p-5 rounded-lg shadow-sm border-emerald-100"
                >
                    <p
                        class="text-[11px] font-bold text-slate-400 uppercase tracking-widest mb-1.5"
                    >
                        Reclamaciones
                    </p>
                    <h3
                        class="text-3xl font-bold text-emerald-600 tracking-tight"
                    >
                        {pendingComplaintsCount}
                    </h3>
                </div>
            </div>

            <div class="flex flex-col gap-12">
                <!-- Gestión de Habitaciones (Ahora en 2 Columnas) -->
                <section>
                    <div class="flex items-center justify-between mb-5 px-1">
                        <h4
                            class="text-xs font-bold text-slate-500 uppercase tracking-[0.2em]"
                        >
                            Gestión de Estados
                        </h4>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 w-full">
                        {
                            rooms.map((room) => {
                                const config = statusConfig;
                                const images = getRoomImages(room.images);
                                const totalRooms = room.units.length;

                                return (
                                    <div class="bg-white border border-slate-200 p-6 rounded-2xl flex flex-col gap-6 group hover:border-[#00a19b]/30 hover:shadow-xl hover:shadow-slate-200/20 transition-all duration-300">
                                        <div class="flex items-center justify-between gap-6">
                                            <div class="flex items-center gap-6 min-w-0">
                                                <div class="w-20 h-20 rounded-xl overflow-hidden bg-slate-100 flex-shrink-0 border border-slate-100 shadow-inner">
                                                    <img
                                                        src={images[0]}
                                                        alt={room.subtitle}
                                                        class="w-full h-full object-cover grayscale-[0.2] group-hover:grayscale-0 group-hover:scale-110 transition-all duration-500"
                                                    />
                                                </div>
                                                <div class="min-w-0">
                                                    <div class="flex items-center gap-3 mb-1">
                                                        <h5 class="text-xl font-bold text-slate-900 truncate tracking-tight">
                                                            {room.subtitle}
                                                        </h5>
                                                        <div class="flex items-center gap-1">
                                                            <span class="px-2 py-0.5 bg-slate-100 text-slate-500 text-[10px] font-bold rounded-md uppercase tracking-wider">
                                                                {totalRooms}{" "}
                                                                {totalRooms ===
                                                                1
                                                                    ? "Unidad"
                                                                    : "Unidades"}
                                                            </span>
                                                            <div class="flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                                                <button
                                                                    class="qty-btn-minus w-5 h-5 rounded bg-slate-50 border border-slate-200 flex items-center justify-center text-slate-400 hover:bg-rose-50 hover:text-rose-600 hover:border-rose-100 transition-colors"
                                                                    title="Eliminar una unidad disponible"
                                                                    data-category={
                                                                        room.subtitle
                                                                    }
                                                                >
                                                                    <svg
                                                                        xmlns="http://www.w3.org/2000/svg"
                                                                        class="w-3 h-3"
                                                                        fill="none"
                                                                        viewBox="0 0 24 24"
                                                                        stroke="currentColor"
                                                                        stroke-width="3"
                                                                    >
                                                                        <path
                                                                            stroke-linecap="round"
                                                                            stroke-linejoin="round"
                                                                            d="M20 12H4"
                                                                        />
                                                                    </svg>
                                                                </button>
                                                                <button
                                                                    class="qty-btn-plus w-5 h-5 rounded bg-slate-50 border border-slate-200 flex items-center justify-center text-slate-400 hover:bg-emerald-50 hover:text-emerald-600 hover:border-emerald-100 transition-colors"
                                                                    title="Añadir una unidad nueva"
                                                                    data-category={
                                                                        room.subtitle
                                                                    }
                                                                >
                                                                    <svg
                                                                        xmlns="http://www.w3.org/2000/svg"
                                                                        class="w-3 h-3"
                                                                        fill="none"
                                                                        viewBox="0 0 24 24"
                                                                        stroke="currentColor"
                                                                        stroke-width="3"
                                                                    >
                                                                        <path
                                                                            stroke-linecap="round"
                                                                            stroke-linejoin="round"
                                                                            d="M12 4v16m8-8H4"
                                                                        />
                                                                    </svg>
                                                                </button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <p class="text-xs text-slate-400 font-medium truncate uppercase tracking-[0.1em]">
                                                        Tarifa Base
                                                    </p>
                                                    <div
                                                        class="price-container flex items-center gap-3 mt-1"
                                                        data-category={
                                                            room.subtitle
                                                        }
                                                    >
                                                        <div class="price-view flex items-center gap-2">
                                                            <span class="text-lg font-bold text-[#00a19b]">
                                                                S/ {room.price}
                                                            </span>
                                                            <button
                                                                class="edit-price-btn p-1.5 text-slate-400 hover:text-[#00a19b] transition-colors"
                                                                title="Editar precio de categoría"
                                                            >
                                                                <svg
                                                                    xmlns="http://www.w3.org/2000/svg"
                                                                    class="w-4 h-4"
                                                                    fill="none"
                                                                    viewBox="0 0 24 24"
                                                                    stroke="currentColor"
                                                                >
                                                                    <path
                                                                        stroke-linecap="round"
                                                                        stroke-linejoin="round"
                                                                        stroke-width="2"
                                                                        d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"
                                                                    />
                                                                </svg>
                                                            </button>
                                                        </div>
                                                        <div class="price-edit hidden flex items-center gap-2">
                                                            <input
                                                                type="number"
                                                                value={
                                                                    room.price
                                                                }
                                                                step="0.1"
                                                                class="w-24 bg-slate-50 border border-[#00a19b]/30 rounded-lg py-1 px-2 text-sm font-bold text-[#00a19b] focus:ring-2 focus:ring-[#00a19b]/20 focus:outline-none transition-all room-price-input"
                                                            />
                                                            <div class="flex gap-1">
                                                                <button
                                                                    class="save-price-btn p-1.5 bg-[#00a19b] text-white rounded-md hover:bg-[#008c87] transition-colors"
                                                                    title="Guardar para todas"
                                                                >
                                                                    <svg
                                                                        xmlns="http://www.w3.org/2000/svg"
                                                                        class="w-3.5 h-3.5"
                                                                        fill="none"
                                                                        viewBox="0 0 24 24"
                                                                        stroke="currentColor"
                                                                    >
                                                                        <path
                                                                            stroke-linecap="round"
                                                                            stroke-linejoin="round"
                                                                            stroke-width="3"
                                                                            d="M5 13l4 4L19 7"
                                                                        />
                                                                    </svg>
                                                                </button>
                                                                <button
                                                                    class="cancel-price-btn p-1.5 bg-slate-100 text-slate-400 rounded-md hover:bg-slate-200 hover:text-slate-600 transition-colors"
                                                                    title="Cancelar"
                                                                >
                                                                    <svg
                                                                        xmlns="http://www.w3.org/2000/svg"
                                                                        class="w-3.5 h-3.5"
                                                                        fill="none"
                                                                        viewBox="0 0 24 24"
                                                                        stroke="currentColor"
                                                                    >
                                                                        <path
                                                                            stroke-linecap="round"
                                                                            stroke-linejoin="round"
                                                                            stroke-width="3"
                                                                            d="M6 18L18 6M6 6l12 12"
                                                                        />
                                                                    </svg>
                                                                </button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>

                                            <div class="flex flex-col items-end gap-1">
                                                <div class="flex items-center gap-2 px-3 py-1 bg-emerald-50 text-emerald-600 rounded-full border border-emerald-100/50">
                                                    <div class="w-1.5 h-1.5 rounded-full bg-emerald-500" />
                                                    <span class="text-[10px] font-bold uppercase tracking-widest">
                                                        {room.counts.libre}{" "}
                                                        Libres
                                                    </span>
                                                </div>
                                                <div class="flex items-center gap-2 px-3 py-1 bg-rose-50 text-rose-600 rounded-full border border-rose-100/50 text-right">
                                                    <div class="w-1.5 h-1.5 rounded-full bg-rose-500" />
                                                    <span class="text-[10px] font-bold uppercase tracking-widest">
                                                        {room.counts.ocupado +
                                                            room.counts
                                                                .reservado}{" "}
                                                        Ocupadas
                                                    </span>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 pt-4 border-t border-slate-50">
                                            {Object.entries(room.counts).map(
                                                ([status, count]) => {
                                                    if (count === 0)
                                                        return null;
                                                    const cfg =
                                                        statusConfig[
                                                            status as keyof typeof statusConfig
                                                        ];
                                                    return (
                                                        <div class="flex items-center justify-between p-3 bg-slate-50/50 rounded-xl border border-slate-100">
                                                            <div class="flex flex-col">
                                                                <span
                                                                    class={`text-[10px] font-black uppercase tracking-tighter ${cfg.color}`}
                                                                >
                                                                    {count} x{" "}
                                                                    {cfg.label}
                                                                </span>
                                                            </div>
                                                            <div class="relative group/select">
                                                                <select
                                                                    class="appearance-none bg-white border border-slate-200 rounded-lg py-1 pl-3 pr-8 text-[9px] font-bold text-slate-500 hover:border-[#00a19b] transition-all cursor-pointer transition-status-btn"
                                                                    data-category={
                                                                        room.subtitle
                                                                    }
                                                                    data-from-status={
                                                                        status
                                                                    }
                                                                >
                                                                    <option
                                                                        value=""
                                                                        disabled
                                                                        selected
                                                                    >
                                                                        MOVER
                                                                        A...
                                                                    </option>
                                                                    {Object.entries(
                                                                        statusConfig,
                                                                    ).map(
                                                                        ([
                                                                            key,
                                                                            item,
                                                                        ]) =>
                                                                            key !==
                                                                                status && (
                                                                                <option
                                                                                    value={
                                                                                        key
                                                                                    }
                                                                                >
                                                                                    {item.label.toUpperCase()}
                                                                                </option>
                                                                            ),
                                                                    )}
                                                                </select>
                                                                <div class="absolute right-2 top-1/2 -translate-y-1/2 pointer-events-none text-slate-300">
                                                                    <svg
                                                                        xmlns="http://www.w3.org/2000/svg"
                                                                        class="w-2.5 h-2.5"
                                                                        fill="none"
                                                                        viewBox="0 0 24 24"
                                                                        stroke="currentColor"
                                                                    >
                                                                        <path
                                                                            stroke-linecap="round"
                                                                            stroke-linejoin="round"
                                                                            stroke-width="3"
                                                                            d="M19 9l-7 7-7-7"
                                                                        />
                                                                    </svg>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    );
                                                },
                                            )}
                                        </div>
                                    </div>
                                );
                            })
                        }
                    </div>
                </section>

                <!-- Libro de Reclamaciones -->
                <section id="reclamaciones">
                    <div class="flex items-center justify-between mb-5 px-1">
                        <h4
                            class="text-xs font-bold text-slate-500 uppercase tracking-[0.2em]"
                        >
                            Libro de Reclamaciones (Quejas y Reclamos)
                        </h4>
                    </div>

                    <div
                        class="bg-white border border-slate-200 rounded-lg overflow-hidden shadow-sm"
                    >
                        <table class="w-full text-left border-collapse">
                            <thead
                                class="bg-slate-50 border-b border-slate-200"
                            >
                                <tr>
                                    <th
                                        class="py-3 px-6 text-[11px] font-bold text-slate-500 uppercase tracking-widest"
                                        >Fecha</th
                                    >
                                    <th
                                        class="py-3 px-6 text-[11px] font-bold text-slate-500 uppercase tracking-widest"
                                        >Código</th
                                    >
                                    <th
                                        class="py-3 px-6 text-[11px] font-bold text-slate-500 uppercase tracking-widest"
                                        >Cliente</th
                                    >
                                    <th
                                        class="py-3 px-6 text-[11px] font-bold text-slate-500 uppercase tracking-widest"
                                        >Tipo</th
                                    >
                                    <th
                                        class="py-3 px-6 text-[11px] font-bold text-slate-500 uppercase tracking-widest"
                                        >Descripción</th
                                    >
                                    <th
                                        class="py-3 px-6 text-[11px] font-bold text-slate-500 uppercase tracking-widest text-right"
                                        >Estado / Acción</th
                                    >
                                </tr>
                            </thead>
                            <tbody id="complaints-body">
                                {
                                    complaints.length === 0 ? (
                                        <tr>
                                            <td
                                                colspan="7"
                                                class="py-20 text-center text-[10px] font-bold text-slate-300 uppercase tracking-widest"
                                            >
                                                No hay registros en el libro
                                            </td>
                                        </tr>
                                    ) : (
                                        complaints.map((c) => (
                                            <tr
                                                class="complaint-row hover:bg-slate-50/50 transition-colors border-b border-slate-100 last:border-0"
                                                data-complaint={JSON.stringify(
                                                    c,
                                                )}
                                            >
                                                <td class="py-4 px-6 text-xs text-slate-400 font-medium">
                                                    {new Date(
                                                        c.date,
                                                    ).toLocaleDateString(
                                                        "es-PE",
                                                    )}
                                                </td>
                                                <td class="py-4 px-6 text-[10px] font-mono text-slate-400">
                                                    {c.id}
                                                </td>
                                                <td class="py-4 px-6">
                                                    <div class="flex flex-col">
                                                        <span class="text-xs font-bold text-slate-900">
                                                            {c.full_name}
                                                        </span>
                                                        <span class="text-[10px] text-slate-500 font-medium">
                                                            {c.email}
                                                        </span>
                                                        <span class="text-[9px] text-slate-400">
                                                            {c.document_type}:{" "}
                                                            {c.document_number}
                                                        </span>
                                                    </div>
                                                </td>
                                                <td class="py-4 px-6">
                                                    <span
                                                        class={`px-2 py-0.5 rounded-full text-[9px] font-bold uppercase tracking-wider ${
                                                            c.type === "QUEJA"
                                                                ? "bg-amber-50 text-amber-600"
                                                                : "bg-red-50 text-red-600"
                                                        }`}
                                                    >
                                                        {c.type}
                                                    </span>
                                                </td>
                                                <td class="py-4 px-6 text-xs text-slate-600 max-w-[300px] truncate-2-lines italic">
                                                    "{c.description}"
                                                </td>
                                                <td class="py-4 px-6 text-right">
                                                    <div class="flex items-center justify-end gap-2">
                                                        <button
                                                            class="download-complaint-pdf-btn p-2 text-rose-600 hover:bg-rose-50 rounded-lg transition-all border border-rose-100/50"
                                                            title="Descargar PDF de Reclamación"
                                                        >
                                                            <svg
                                                                xmlns="http://www.w3.org/2000/svg"
                                                                class="w-4 h-4"
                                                                fill="none"
                                                                viewBox="0 0 24 24"
                                                                stroke="currentColor"
                                                            >
                                                                <path
                                                                    stroke-linecap="round"
                                                                    stroke-linejoin="round"
                                                                    stroke-width="2"
                                                                    d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"
                                                                />
                                                            </svg>
                                                        </button>

                                                        <button
                                                            class="delete-complaint-btn p-2 text-slate-400 hover:text-rose-600 hover:bg-rose-50 rounded-lg transition-all border border-slate-100 hover:border-rose-100"
                                                            title="Eliminar Reclamación"
                                                            data-id={c.id}
                                                        >
                                                            <svg
                                                                xmlns="http://www.w3.org/2000/svg"
                                                                class="w-4 h-4"
                                                                fill="none"
                                                                viewBox="0 0 24 24"
                                                                stroke="currentColor"
                                                            >
                                                                <path
                                                                    stroke-linecap="round"
                                                                    stroke-linejoin="round"
                                                                    stroke-width="2"
                                                                    d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-4v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"
                                                                />
                                                            </svg>
                                                        </button>

                                                        {c.status ===
                                                        "PENDIENTE" ? (
                                                            <button
                                                                class="complaint-status-btn px-3 py-1 bg-emerald-50 text-emerald-600 hover:bg-emerald-600 hover:text-white rounded-md text-[10px] font-bold uppercase tracking-widest transition-all border border-emerald-100"
                                                                data-id={c.id}
                                                            >
                                                                Atender
                                                            </button>
                                                        ) : (
                                                            <span class="px-3 py-1 bg-slate-50 text-slate-400 rounded-md text-[10px] font-bold uppercase tracking-widest border border-slate-100">
                                                                Atendido
                                                            </span>
                                                        )}
                                                    </div>
                                                </td>
                                            </tr>
                                        ))
                                    )
                                }
                            </tbody>
                        </table>

                        {
                            complaints.length > 10 && (
                                <div class="bg-slate-50 border-t border-slate-200 px-6 py-3 flex items-center justify-between">
                                    <div class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">
                                        Mostrando{" "}
                                        <span id="complaint-range">1-10</span>{" "}
                                        de {complaints.length}
                                    </div>
                                    <div class="flex gap-2">
                                        <button
                                            id="prev-complaint-page"
                                            class="px-3 py-1 bg-white border border-slate-200 rounded text-[10px] font-bold text-slate-600 hover:bg-slate-50 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
                                            disabled
                                        >
                                            Anterior
                                        </button>
                                        <button
                                            id="next-complaint-page"
                                            class="px-3 py-1 bg-white border border-slate-200 rounded text-[10px] font-bold text-slate-600 hover:bg-slate-50 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
                                        >
                                            Siguiente
                                        </button>
                                    </div>
                                </div>
                            )
                        }
                    </div>
                </section>

                <!-- Historial de Transacciones (Ahora Tabla de Ancho Completo) -->
                <section>
                    <div class="flex items-center justify-between mb-5 px-1">
                        <h4
                            class="text-xs font-bold text-slate-500 uppercase tracking-[0.2em]"
                        >
                            Registro Completo de Transacciones
                        </h4>
                        <div class="flex items-center gap-3">
                            <div class="flex flex-col items-end mr-3">
                                <span
                                    class="text-[8px] font-black text-slate-300 uppercase tracking-widest leading-none"
                                    >Auto-Sync</span
                                >
                                <span
                                    id="last-sync-time"
                                    class="text-[10px] font-bold text-[#00a19b] leading-tight"
                                    >Última: {lastSyncDate}</span
                                >
                            </div>

                            <button
                                id="sync-all-btn"
                                class="h-9 px-4 bg-[#00a19b]/10 text-[#00a19b] border border-[#00a19b]/20 rounded-lg text-[10px] font-bold hover:bg-[#00a19b] hover:text-white transition-all flex items-center gap-2 uppercase tracking-widest active:scale-95 group"
                            >
                                <svg
                                    xmlns="http://www.w3.org/2000/svg"
                                    class="w-3 h-3"
                                    fill="none"
                                    viewBox="0 0 24 24"
                                    stroke="currentColor"
                                >
                                    <path
                                        stroke-linecap="round"
                                        stroke-linejoin="round"
                                        stroke-width="2"
                                        d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
                                    ></path>
                                </svg>
                                Sincronizar
                            </button>

                            <div class="h-6 w-px bg-slate-200"></div>

                            <div class="flex items-center gap-2">
                                <button
                                    id="export-excel-btn"
                                    class="text-[10px] font-bold text-emerald-600 hover:bg-emerald-50 border border-emerald-200 px-3 py-1.5 rounded-lg transition-all flex items-center gap-2 uppercase tracking-widest bg-white shadow-sm"
                                >
                                    <svg
                                        xmlns="http://www.w3.org/2000/svg"
                                        class="w-3 h-3"
                                        fill="none"
                                        viewBox="0 0 24 24"
                                        stroke="currentColor"
                                    >
                                        <path
                                            stroke-linecap="round"
                                            stroke-linejoin="round"
                                            stroke-width="2"
                                            d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
                                        ></path>
                                    </svg>
                                    Excel
                                </button>
                                <button
                                    id="export-pdf-btn"
                                    class="text-[10px] font-bold text-rose-600 hover:bg-rose-50 border border-rose-200 px-3 py-1.5 rounded-lg transition-all flex items-center gap-2 uppercase tracking-widest bg-white shadow-sm"
                                >
                                    <svg
                                        xmlns="http://www.w3.org/2000/svg"
                                        class="w-3 h-3"
                                        fill="none"
                                        viewBox="0 0 24 24"
                                        stroke="currentColor"
                                    >
                                        <path
                                            stroke-linecap="round"
                                            stroke-linejoin="round"
                                            stroke-width="2"
                                            d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"
                                        ></path>
                                    </svg>
                                    PDF
                                </button>
                            </div>
                        </div>
                    </div>

                    <div
                        class="bg-white border border-slate-200 rounded-lg overflow-hidden shadow-sm"
                    >
                        <table class="w-full text-left border-collapse">
                            <thead
                                class="bg-slate-50 border-b border-slate-200"
                            >
                                <tr>
                                    <th
                                        class="py-3 px-6 text-[11px] font-bold text-slate-500 uppercase tracking-widest"
                                        >Fecha y Hora</th
                                    >
                                    <th
                                        class="py-3 px-6 text-[11px] font-bold text-slate-500 uppercase tracking-widest"
                                        >Orden ID</th
                                    >
                                    <th
                                        class="py-3 px-6 text-[11px] font-bold text-slate-500 uppercase tracking-widest"
                                        >Cliente</th
                                    >
                                    <th
                                        class="py-3 px-6 text-[11px] font-bold text-slate-500 uppercase tracking-widest"
                                        >Alojamiento</th
                                    >
                                    <th
                                        class="py-3 px-6 text-[11px] font-bold text-slate-500 uppercase tracking-widest text-right"
                                        >Monto</th
                                    >
                                    <th
                                        class="py-3 px-6 text-[11px] font-bold text-slate-500 uppercase tracking-widest text-center"
                                        >Estado</th
                                    >
                                    <th
                                        class="py-3 px-6 text-[11px] font-bold text-slate-500 uppercase tracking-widest text-center"
                                        >Acciones</th
                                    >
                                </tr>
                            </thead>
                            <tbody
                                id="transactions-body"
                                class="divide-y divide-slate-100"
                            >
                                {
                                    transactions.length === 0 ? (
                                        <tr>
                                            <td
                                                colspan="7"
                                                class="py-20 text-center text-[10px] font-bold text-slate-300 uppercase tracking-widest"
                                            >
                                                No se encontraron transacciones
                                            </td>
                                        </tr>
                                    ) : (
                                        transactions.map((tx, index) => (
                                            <tr
                                                class="tx-row hover:bg-slate-50/50 transition-colors"
                                                data-index={index}
                                            >
                                                <td class="py-4 px-6 text-[10px] text-slate-400 font-bold uppercase tracking-tight">
                                                    {new Date(tx.timestamp)
                                                        .toLocaleString(
                                                            "es-PE",
                                                            {
                                                                timeZone:
                                                                    "America/Lima",
                                                                day: "2-digit",
                                                                month: "2-digit",
                                                                year: "numeric",
                                                                hour: "2-digit",
                                                                minute: "2-digit",
                                                                hour12: true,
                                                            },
                                                        )
                                                        .replace(",", " -")}
                                                </td>
                                                <td class="py-4 px-6 text-xs font-mono text-slate-300">
                                                    {tx.order_id}
                                                </td>
                                                <td class="py-4 px-6">
                                                    {(() => {
                                                        try {
                                                            const client =
                                                                JSON.parse(
                                                                    tx.customer,
                                                                );
                                                            return (
                                                                <div class="flex flex-col">
                                                                    <span class="text-xs font-bold text-slate-900">
                                                                        {
                                                                            client.firstName
                                                                        }{" "}
                                                                        {
                                                                            client.lastName
                                                                        }
                                                                    </span>
                                                                    <span class="text-[10px] text-slate-500 font-medium">
                                                                        {
                                                                            client.email
                                                                        }
                                                                    </span>
                                                                    {client.dni && (
                                                                        <span class="text-[10px] text-slate-400">
                                                                            DNI:{" "}
                                                                            {
                                                                                client.dni
                                                                            }
                                                                        </span>
                                                                    )}
                                                                    {client.phone && (
                                                                        <span class="text-[10px] text-slate-400">
                                                                            Telf:{" "}
                                                                            {
                                                                                client.phone
                                                                            }
                                                                        </span>
                                                                    )}
                                                                </div>
                                                            );
                                                        } catch (e) {
                                                            return (
                                                                <span class="text-xs font-medium text-slate-600">
                                                                    {
                                                                        tx.customer
                                                                    }
                                                                </span>
                                                            );
                                                        }
                                                    })()}
                                                </td>
                                                <td class="py-4 px-6">
                                                    <p class="text-sm font-bold text-slate-900 leading-none">
                                                        {tx.room_name}
                                                    </p>
                                                </td>
                                                <td class="py-4 px-6 text-right">
                                                    <p class="text-sm font-bold text-slate-900 tracking-tight">
                                                        S/{" "}
                                                        {tx.amount.toFixed(2)}
                                                    </p>
                                                </td>
                                                <td class="py-4 px-6 text-center">
                                                    <span
                                                        class={`text-[10px] font-medium uppercase inline-block px-2 py-1 rounded-md border ${
                                                            tx.status ===
                                                            "EXITOSO"
                                                                ? "bg-emerald-50 text-emerald-600 border-emerald-100"
                                                                : tx.status ===
                                                                    "PENDIENTE"
                                                                  ? "bg-amber-50 text-amber-600 border-amber-100"
                                                                  : tx.status ===
                                                                      "CANCELADO"
                                                                    ? "bg-slate-50 text-slate-500 border-slate-200"
                                                                    : tx.status ===
                                                                        "INICIADO"
                                                                      ? "bg-slate-400/10 text-slate-400 border-slate-200"
                                                                      : "bg-rose-50 text-rose-600 border-rose-100"
                                                        }`}
                                                    >
                                                        {tx.status ===
                                                        "CANCELADO"
                                                            ? "ANULADO"
                                                            : tx.status ===
                                                                "INICIADO"
                                                              ? "EN PROCESO"
                                                              : tx.status}
                                                    </span>
                                                </td>
                                                <td class="py-4 px-6 text-center">
                                                    <button
                                                        class="delete-tx-btn p-2 text-slate-300 hover:text-rose-500 hover:bg-rose-50 rounded-lg transition-all active:scale-90"
                                                        data-order-id={
                                                            tx.order_id
                                                        }
                                                        title="Eliminar transacción"
                                                    >
                                                        <svg
                                                            xmlns="http://www.w3.org/2000/svg"
                                                            class="w-4 h-4"
                                                            fill="none"
                                                            viewBox="0 0 24 24"
                                                            stroke="currentColor"
                                                        >
                                                            <path
                                                                stroke-linecap="round"
                                                                stroke-linejoin="round"
                                                                stroke-width="2"
                                                                d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"
                                                            />
                                                        </svg>
                                                    </button>
                                                </td>
                                            </tr>
                                        ))
                                    )
                                }
                            </tbody>
                        </table>

                        {
                            transactions.length > 10 && (
                                <div class="bg-slate-50 border-t border-slate-200 px-6 py-3 flex items-center justify-between">
                                    <div class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">
                                        Mostrando{" "}
                                        <span id="current-range">1-10</span> de{" "}
                                        {transactions.length}
                                    </div>
                                    <div class="flex gap-2">
                                        <button
                                            id="prev-page"
                                            class="px-3 py-1 bg-white border border-slate-200 rounded text-[10px] font-bold text-slate-600 hover:bg-slate-50 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
                                            disabled
                                        >
                                            Anterior
                                        </button>
                                        <button
                                            id="next-page"
                                            class="px-3 py-1 bg-white border border-slate-200 rounded text-[10px] font-bold text-slate-600 hover:bg-slate-50 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
                                        >
                                            Siguiente
                                        </button>
                                    </div>
                                </div>
                            )
                        }
                    </div>
                </section>
            </div>
        </main>
    </div>

    <script>
        import ExcelJS from "exceljs";
        import { saveAs } from "file-saver";
        import jsPDF from "jspdf";
        import autoTable from "jspdf-autotable";

        console.log("📊 Export script initialized");

        // --- EXPORT LOGIC ---
        const getTableData = () => {
            console.log("🔍 Extracting table data...");
            const rows = Array.from(
                document.querySelectorAll("#transactions-body tr.tx-row"),
            );

            console.log(`Found ${rows.length} total transaction rows`);

            const data = rows
                .map((row) => {
                    const cols = row.querySelectorAll("td");
                    if (cols.length < 6) return null;

                    // Extract data by column index to be more robust
                    const date = cols[0].textContent?.trim() || "";
                    const orderId = cols[1].textContent?.trim() || "";

                    // Cliente column (Complex structure)
                    const clientCell = cols[2];
                    const clientDiv =
                        clientCell.querySelector(".flex.flex-col");
                    const clientName =
                        clientDiv?.children[0]?.textContent?.trim() || "";
                    const clientEmail =
                        clientDiv?.children[1]?.textContent?.trim() || "";
                    const clientDni =
                        clientDiv?.children[2]?.textContent?.trim() || "";
                    const client = `${clientName}\n${clientEmail}\n${clientDni}`;

                    const room = cols[3].textContent?.trim() || "";
                    const amount =
                        cols[4].textContent?.trim().replace("S/ ", "") || "";
                    const status = cols[5].textContent?.trim() || "";

                    return [date, orderId, client, room, amount, status];
                })
                .filter((r) => r !== null);

            console.log(
                `Successfully processed ${data.length} rows for export`,
            );
            return data;
        };

        const exportExcelBtn = document.getElementById("export-excel-btn");
        if (exportExcelBtn) {
            exportExcelBtn.addEventListener("click", async () => {
                console.log("📥 Professional Excel export triggered");
                try {
                    const data = getTableData();
                    if (data.length === 0) {
                        alert("No hay datos para exportar");
                        return;
                    }

                    const workbook = new ExcelJS.Workbook();
                    const worksheet = workbook.addWorksheet("Transacciones");

                    // 1. Header Styling & Setup (Bris Hotel Brown #5A3D37)
                    worksheet.mergeCells("A1:E1");
                    const titleCell = worksheet.getCell("A1");
                    titleCell.value = "BRIS HOTEL - REPORTE DE TRANSACCIONES";
                    titleCell.font = {
                        name: "Arial Black",
                        size: 12,
                        color: { argb: "FFFFFFFF" },
                    };
                    titleCell.alignment = {
                        vertical: "middle",
                        horizontal: "center",
                    };
                    titleCell.fill = {
                        type: "pattern",
                        pattern: "solid",
                        fgColor: { argb: "FF5A3D37" },
                    };

                    // Calculating Totals
                    const totalMonto = data.reduce(
                        (acc, curr) => acc + (parseFloat(curr[4]) || 0),
                        0,
                    );

                    // Total Cell at the side
                    const totalCell = worksheet.getCell("F1");
                    totalCell.value = `TOTAL: S/ ${totalMonto.toFixed(2)}`;
                    totalCell.font = {
                        bold: true,
                        size: 12,
                        color: { argb: "FFFFFFFF" },
                    };
                    totalCell.fill = {
                        type: "pattern",
                        pattern: "solid",
                        fgColor: { argb: "FF759120" },
                    };
                    totalCell.alignment = {
                        vertical: "middle",
                        horizontal: "center",
                    };
                    totalCell.border = {
                        right: { style: "thin" },
                        bottom: { style: "thin" },
                    };

                    worksheet.mergeCells("A2:F2");
                    const metaCell = worksheet.getCell("A2");
                    metaCell.value = `Generado el: ${new Date().toLocaleString("es-PE")}`;
                    metaCell.font = { name: "Arial", size: 9, italic: true };
                    metaCell.alignment = { horizontal: "center" };

                    // 2. Main Table Headers (Bris Hotel Green #759120)
                    const headerRow = worksheet.addRow([
                        "FECHA",
                        "ID ORDEN",
                        "CLIENTE",
                        "HABITACIÓN",
                        "MONTO",
                        "ESTADO",
                    ]);
                    headerRow.height = 25;
                    headerRow.eachCell((cell) => {
                        cell.fill = {
                            type: "pattern",
                            pattern: "solid",
                            fgColor: { argb: "FF759120" },
                        };
                        cell.font = {
                            bold: true,
                            color: { argb: "FFFFFFFF" },
                            size: 9,
                        };
                        cell.alignment = {
                            vertical: "middle",
                            horizontal: "center",
                        };
                        cell.border = {
                            top: { style: "thin" },
                            left: { style: "thin" },
                            bottom: { style: "thin" },
                            right: { style: "thin" },
                        };
                    });

                    // 3. Add Data Rows
                    data.forEach((rowData) => {
                        const row = worksheet.addRow(rowData);
                        row.eachCell((cell, colNumber) => {
                            cell.alignment = {
                                vertical: "middle",
                                wrapText: true,
                            };
                            if (colNumber === 5)
                                cell.alignment.horizontal = "right"; // Amount
                            if (colNumber === 6)
                                cell.alignment.horizontal = "center"; // Status
                            cell.border = {
                                top: { style: "thin" },
                                left: { style: "thin" },
                                bottom: { style: "thin" },
                                right: { style: "thin" },
                            };
                            cell.font = { size: 10 };
                        });
                    });

                    // 4. Column Widths
                    worksheet.getColumn(1).width = 25; // Fecha
                    worksheet.getColumn(2).width = 15; // ID
                    worksheet.getColumn(3).width = 45; // Cliente
                    worksheet.getColumn(4).width = 20; // Hab
                    worksheet.getColumn(5).width = 12; // Monto
                    worksheet.getColumn(6).width = 15; // Estado

                    // 5. Generate and Download
                    const fileName = `BrisHotel_Reporte_${new Date().toISOString().slice(0, 10)}.xlsx`;
                    const buffer = await workbook.xlsx.writeBuffer();
                    saveAs(
                        new Blob([buffer], {
                            type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
                        }),
                        fileName,
                    );
                    console.log(`💾 Excel saved successfully: ${fileName}`);
                } catch (err) {
                    console.error("❌ Excel Export Error:", err);
                    alert(
                        "Error al generar el Excel profesional. Revisa la consola.",
                    );
                }
            });
        }

        const exportPdfBtn = document.getElementById("export-pdf-btn");
        if (exportPdfBtn) {
            exportPdfBtn.addEventListener("click", () => {
                console.log("📥 PDF export triggered");
                try {
                    const data = getTableData();
                    if (data.length === 0) {
                        alert("No hay datos para exportar");
                        return;
                    }

                    const doc = new jsPDF();
                    const pageWidth = doc.internal.pageSize.width;

                    // --- Header Branding (Bris Hotel Brown #5A3D37) ---
                    doc.setFillColor(90, 61, 55);
                    doc.rect(0, 0, pageWidth, 40, "F");

                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(24);
                    doc.setFont("helvetica", "bold");
                    doc.text("Bris Hotel", 14, 22);

                    doc.setFontSize(10);
                    doc.setFont("helvetica", "normal");
                    doc.text("REPORTE OFICIAL DE TRANSACCIONES", 14, 30);

                    doc.setFontSize(8);
                    doc.text(
                        `Generado el: ${new Date().toLocaleString("es-PE")}`,
                        14,
                        36,
                    );

                    autoTable(doc, {
                        startY: 50,
                        head: [
                            [
                                "Fecha",
                                "ID Orden",
                                "Cliente",
                                "Hab.",
                                "Monto",
                                "Estado",
                            ],
                        ],
                        body: data,
                        theme: "grid",
                        headStyles: {
                            fillColor: [117, 145, 32], // Bris Hotel Green #759120
                            textColor: [255, 255, 255],
                            fontStyle: "bold",
                            halign: "center",
                        },
                        columnStyles: {
                            0: { cellWidth: 40 },
                            1: { cellWidth: 25, fontStyle: "bold" },
                            2: { cellWidth: 55 },
                            4: { halign: "right", fontStyle: "bold" },
                            5: { halign: "center" },
                        },
                        didDrawPage: (data) => {
                            const str = "Página " + doc.getNumberOfPages();
                            doc.setFontSize(8);
                            doc.setTextColor(150);
                            doc.text(
                                str,
                                pageWidth - 30,
                                doc.internal.pageSize.height - 10,
                            );
                        },
                    });

                    const fileName = `BrisHotel_Reporte_${new Date().toISOString().slice(0, 10)}.pdf`;
                    console.log(`💾 Saving PDF: ${fileName}`);
                    doc.save(fileName);
                } catch (err) {
                    console.error("❌ PDF Export Error:", err);
                    alert("Error al generar el PDF. Revisa la consola.");
                }
            });
        }

        // --- COMPLAINT PDF EXPORT ---
        const setupComplaintPdfExport = () => {
            const btns = document.querySelectorAll(
                ".download-complaint-pdf-btn",
            );
            btns.forEach((btn) => {
                btn.addEventListener("click", () => {
                    const row = btn.closest("tr");
                    if (!row || !row.dataset.complaint) return;

                    try {
                        const complaint = JSON.parse(row.dataset.complaint);
                        generateComplaintPdf(complaint);
                    } catch (e) {
                        console.error("Error parsing complaint data", e);
                    }
                });
            });
        };

        const generateComplaintPdf = (c: any) => {
            try {
                const doc = new jsPDF();
                const pageWidth = doc.internal.pageSize.width;
                const pageHeight = doc.internal.pageSize.height;

                // --- Foundation: Light Premium Background ---
                doc.setFillColor(253, 251, 249); // #FDFBF9 (Cream)
                doc.rect(0, 0, pageWidth, pageHeight, "F");

                // --- Header Branding (Elegant & Spaced) ---
                doc.setFillColor(90, 61, 55); // #5A3D37 (Hotel Brown)
                doc.rect(0, 0, pageWidth, 45, "F");

                // Gold Accent Line
                doc.setFillColor(117, 145, 32); // #759120 (Hotel Green)
                doc.rect(0, 45, pageWidth, 2, "F");

                doc.setTextColor(255, 255, 255);
                doc.setFont("helvetica", "bold");
                doc.setFontSize(28);
                doc.text("BRIS HOTEL", 20, 25);

                doc.setFont("helvetica", "normal");
                doc.setFontSize(10);
                doc.setTextColor(220, 220, 220);
                doc.text("EXCELENCIA EN HOSPITALIDAD", 21, 32);

                doc.setTextColor(255, 255, 255);
                doc.setFont("helvetica", "bold");
                doc.setFontSize(12);
                doc.text("HOJA DE RECLAMACIÓN VIRTUAL", pageWidth - 20, 25, {
                    align: "right",
                });

                doc.setFont("helvetica", "normal");
                doc.setFontSize(9);
                doc.text(`REGISTRO OFICIAL: ${c.id}`, pageWidth - 20, 32, {
                    align: "right",
                });

                // --- Body Setup ---
                let currentY = 65;
                const margin = 20;
                const contentWidth = pageWidth - margin * 2;

                // Section title helper
                const drawSectionTitle = (title: string, y: number) => {
                    doc.setFont("helvetica", "bold");
                    doc.setFontSize(9);
                    doc.setTextColor(117, 145, 32); // Green accent
                    doc.text(title.toUpperCase(), margin, y);
                    doc.setDrawColor(117, 145, 32, 0.2);
                    doc.line(margin, y + 2, pageWidth - margin, y + 2);
                    return y + 12;
                };

                // Field helper
                const drawField = (label: string, value: string, y: number) => {
                    doc.setFont("helvetica", "bold");
                    doc.setFontSize(8);
                    doc.setTextColor(150, 150, 150);
                    doc.text(label.toUpperCase(), margin, y);

                    doc.setFont("helvetica", "normal");
                    doc.setFontSize(10);
                    doc.setTextColor(60, 60, 60);

                    // Handle multi-line for description
                    if (label.toLowerCase() === "descripción") {
                        const lines = doc.splitTextToSize(
                            value || "-",
                            contentWidth,
                        );
                        doc.text(lines, margin, y + 6);
                        return y + 10 + lines.length * 5;
                    }

                    doc.text(value || "-", margin, y + 6);
                    return y + 15;
                };

                // --- Content Sections ---

                // 1. Consumer Identity
                currentY = drawSectionTitle(
                    "1. Identificación del Consumidor",
                    currentY,
                );
                currentY = drawField("Nombre Completo", c.full_name, currentY);

                const colWidth = contentWidth / 2;
                doc.setFont("helvetica", "bold");
                doc.setFontSize(8);
                doc.setTextColor(150, 150, 150);
                doc.text("DOCUMENTO", margin, currentY);
                doc.text("E-MAIL", margin + colWidth, currentY);

                doc.setFont("helvetica", "normal");
                doc.setFontSize(10);
                doc.setTextColor(60, 60, 60);
                doc.text(
                    `${c.document_type} - ${c.document_number}`,
                    margin,
                    currentY + 6,
                );
                doc.text(c.email, margin + colWidth, currentY + 6);
                currentY += 15;

                doc.setFont("helvetica", "bold");
                doc.setFontSize(8);
                doc.setTextColor(150, 150, 150);
                doc.text("TELÉFONO", margin, currentY);
                doc.text("DOMICILIO", margin + colWidth, currentY);

                doc.setFont("helvetica", "normal");
                doc.setFontSize(10);
                doc.setTextColor(60, 60, 60);
                doc.text(c.phone || "No especificado", margin, currentY + 6);
                doc.text(
                    c.address || "No especificado",
                    margin + colWidth,
                    currentY + 6,
                );
                currentY += 25;

                // 2. Complaint Detail
                currentY = drawSectionTitle(
                    "2. Detalle de la Reclamación",
                    currentY,
                );

                doc.setFont("helvetica", "bold");
                doc.setFontSize(8);
                doc.setTextColor(150, 150, 150);
                doc.text("TIPO", margin, currentY);
                doc.text("FECHA DE REGISTRO", margin + colWidth, currentY);

                doc.setFont("helvetica", "bold");
                doc.setFontSize(10);
                doc.setTextColor(180, 130, 40); // Amber for emphasis
                doc.text(c.type, margin, currentY + 6);

                doc.setFont("helvetica", "normal");
                doc.setTextColor(60, 60, 60);
                doc.text(
                    new Date(c.date).toLocaleString("es-PE"),
                    margin + colWidth,
                    currentY + 6,
                );
                currentY += 15;

                currentY = drawField("Descripción", c.description, currentY);

                // --- Decorative Seal / Status ---
                currentY += 10;
                const isAtendido = c.status === "ATENDIDO";
                const statusBg = isAtendido ? [220, 252, 231] : [254, 243, 199]; // Light Green vs Light Amber
                const statusText = isAtendido ? [21, 128, 61] : [180, 83, 9]; // Dark Green vs Dark Amber

                doc.setDrawColor(
                    statusText[0],
                    statusText[1],
                    statusText[2],
                    0.2,
                );
                doc.setFillColor(statusBg[0], statusBg[1], statusBg[2]);
                doc.roundedRect(pageWidth - 65, currentY, 45, 18, 2, 2, "FD");

                doc.setFont("helvetica", "bold");
                doc.setFontSize(7);
                doc.setTextColor(
                    statusText[0],
                    statusText[1],
                    statusText[2],
                    0.6,
                );
                doc.text("ESTADO ACTUAL", pageWidth - 42.5, currentY + 6, {
                    align: "center",
                });

                doc.setFontSize(9);
                doc.setTextColor(statusText[0], statusText[1], statusText[2]);
                doc.text(
                    c.status.toUpperCase(),
                    pageWidth - 42.5,
                    currentY + 13,
                    { align: "center" },
                );

                // --- Footer ---
                const footerY = pageHeight - 30;
                doc.setDrawColor(200, 200, 200);
                doc.setLineWidth(0.1);
                doc.line(margin, footerY, pageWidth - margin, footerY);

                doc.setFontSize(7);
                doc.setTextColor(180, 180, 180);
                const disclaimer =
                    "Este documento electrónico tiene validez legal conforme a la Ley de Protección al Consumidor. Bris Hotel garantiza la integridad y confidencialidad de la información registrada.";
                const splitDisclaimer = doc.splitTextToSize(
                    disclaimer,
                    contentWidth,
                );
                doc.text(splitDisclaimer, margin, footerY + 8);

                doc.setFont("helvetica", "bold");
                doc.text(
                    "BRIS HOTEL NASCA - CALLE CALLAO 907, NASCA, PERÚ",
                    pageWidth / 2,
                    footerY + 20,
                    { align: "center" },
                );

                const fileName = `BrisHotel_Reclamacion_${c.id}.pdf`;
                doc.save(fileName);
            } catch (err) {
                console.error("❌ Complaint PDF Error:", err);
                alert("Error al generar el PDF de reclamación premium.");
            }
        };

        // Initialize complaint export
        setupComplaintPdfExport();
    </script>
</Layout>

<script is:inline>
    // 🔄 Transición de Estados por Categoría
    const transitionSelects = document.querySelectorAll(
        ".transition-status-btn",
    );
    transitionSelects.forEach((select) => {
        select.addEventListener("change", async (e) => {
            const category = e.target.dataset.category;
            const fromStatus = e.target.dataset.fromStatus;
            const toStatus = e.target.value;
            const card = e.target.closest("div.group");

            if (!toStatus) return;

            e.target.disabled = true;
            if (card) card.style.opacity = "0.3";

            try {
                const response = await fetch("/api/admin/rooms", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        category,
                        fromStatus,
                        toStatus,
                    }),
                });
                if (response.ok) window.location.reload();
                else throw new Error();
            } catch (err) {
                alert("Error en el servidor al realizar la transición");
                window.location.reload();
            }
        });
    });

    // 💰 Gestión de Precios por Categoría
    const priceContainers = document.querySelectorAll(".price-container");
    priceContainers.forEach((container) => {
        const category = container.dataset.category;
        const viewMode = container.querySelector(".price-view");
        const editMode = container.querySelector(".price-edit");
        const input = container.querySelector(".room-price-input");
        const editBtn = container.querySelector(".edit-price-btn");
        const saveBtn = container.querySelector(".save-price-btn");
        const cancelBtn = container.querySelector(".cancel-price-btn");
        const card = container.closest("div.group");

        editBtn.addEventListener("click", () => {
            viewMode.classList.add("hidden");
            editMode.classList.remove("hidden");
            input.focus();
        });

        // Cerrar al pulsar X
        cancelBtn.addEventListener("click", () => {
            editMode.classList.add("hidden");
            viewMode.classList.remove("hidden");
            input.value = input.defaultValue;
        });

        // Cerrar al perder foco o ESC
        input.addEventListener("keydown", (e) => {
            if (e.key === "Escape") {
                editMode.classList.add("hidden");
                viewMode.classList.remove("hidden");
            }
        });

        saveBtn.addEventListener("click", async () => {
            const newPrice = input.value;

            saveBtn.disabled = true;
            input.disabled = true;
            if (card) card.style.opacity = "0.5";

            try {
                const response = await fetch("/api/admin/rooms", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ category, price: newPrice }),
                });
                if (response.ok) {
                    window.location.reload();
                } else {
                    throw new Error();
                }
            } catch (err) {
                alert("Error al actualizar el precio de la categoría");
                saveBtn.disabled = false;
                input.disabled = false;
                if (card) card.style.opacity = "1";
            }
        });
    });

    // 🔢 Paginación de Transacciones
    let currentTxPage = 1;
    const txPerPage = 10;
    const txRows = document.querySelectorAll(".tx-row");
    const totalTx = txRows.length;
    const prevBtn = document.getElementById("prev-page");
    const nextBtn = document.getElementById("next-page");
    const rangeText = document.getElementById("current-range");

    function updateTxPagination() {
        if (!txRows.length) return;

        const start = (currentTxPage - 1) * txPerPage;
        const end = start + txPerPage;

        txRows.forEach((row, index) => {
            if (index >= start && index < end) {
                row.style.display = "";
            } else {
                row.style.display = "none";
            }
        });

        if (rangeText) {
            rangeText.textContent = `${start + 1}-${Math.min(end, totalTx)}`;
        }
        if (prevBtn) prevBtn.disabled = currentTxPage === 1;
        if (nextBtn) nextBtn.disabled = end >= totalTx;
    }

    if (prevBtn && nextBtn) {
        prevBtn.addEventListener("click", () => {
            if (currentTxPage > 1) {
                currentTxPage--;
                updateTxPagination();
            }
        });
        nextBtn.addEventListener("click", () => {
            if (currentTxPage * txPerPage < totalTx) {
                currentTxPage++;
                updateTxPagination();
            }
        });
        updateTxPagination(); // Inicializar
    }

    // 🔢 Paginación de Libro de Reclamaciones
    let currentComplaintPage = 1;
    const complaintsPerPage = 10;
    const complaintRows = document.querySelectorAll(".complaint-row");
    const totalComplaints = complaintRows.length;
    const prevComplaintBtn = document.getElementById("prev-complaint-page");
    const nextComplaintBtn = document.getElementById("next-complaint-page");
    const complaintRangeText = document.getElementById("complaint-range");

    function updateComplaintPagination() {
        if (!complaintRows.length) return;

        const start = (currentComplaintPage - 1) * complaintsPerPage;
        const end = start + complaintsPerPage;

        complaintRows.forEach((row, index) => {
            if (index >= start && index < end) {
                row.style.display = "";
            } else {
                row.style.display = "none";
            }
        });

        if (complaintRangeText) {
            complaintRangeText.textContent = `${start + 1}-${Math.min(end, totalComplaints)}`;
        }
        if (prevComplaintBtn)
            prevComplaintBtn.disabled = currentComplaintPage === 1;
        if (nextComplaintBtn)
            nextComplaintBtn.disabled = end >= totalComplaints;
    }

    if (prevComplaintBtn && nextComplaintBtn) {
        prevComplaintBtn.addEventListener("click", () => {
            if (currentComplaintPage > 1) {
                currentComplaintPage--;
                updateComplaintPagination();
            }
        });
        nextComplaintBtn.addEventListener("click", () => {
            if (currentComplaintPage * complaintsPerPage < totalComplaints) {
                currentComplaintPage++;
                updateComplaintPagination();
            }
        });
        updateComplaintPagination(); // Inicializar
    }

    // 🏗️ Gestión de Cantidades (Añadir/Eliminar unidades)
    const qtyPlusBtns = document.querySelectorAll(".qty-btn-plus");
    const qtyMinusBtns = document.querySelectorAll(".qty-btn-minus");

    const updateQuantity = async (category, action) => {
        try {
            const response = await fetch("/api/admin/rooms", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ category, action }),
            });
            if (response.ok) window.location.reload();
            else throw new Error();
        } catch (err) {
            alert("Error al actualizar la cantidad de unidades");
        }
    };

    qtyPlusBtns.forEach((btn) => {
        btn.addEventListener("click", () => {
            const category = btn.dataset.category;
            updateQuantity(category, "add_unit");
        });
    });

    qtyMinusBtns.forEach((btn) => {
        btn.addEventListener("click", () => {
            if (
                !confirm(
                    "¿Seguro que deseas eliminar una unidad de esta categoría? (Solo se eliminarán unidades libres)",
                )
            )
                return;
            const category = btn.dataset.category;
            updateQuantity(category, "remove_unit");
        });
    });

    // 🔄 Sincronización Global de Pagos Pendientes
    async function syncAllTransactions(isAuto = false) {
        const syncAllBtn = document.getElementById("sync-all-btn");
        const statusText = document.getElementById("last-sync-time");

        // Seleccionar todas las órdenes presentes en la tabla (RES-XXXX)
        const allOrders = Array.from(document.querySelectorAll("td"))
            .map((td) => td.textContent.trim())
            .filter((text) => text.startsWith("RES-"));

        if (allOrders.length === 0) {
            if (!isAuto) alert("No hay transacciones para sincronizar.");
            return;
        }

        let originalText = "";
        if (syncAllBtn && !isAuto) {
            syncAllBtn.disabled = true;
            originalText = syncAllBtn.innerHTML;
            syncAllBtn.innerHTML = " Sincronizando...";
        }

        console.log(
            `[${isAuto ? "AUTO" : "MANUAL"}] Sincronizando ${allOrders.length} órdenes...`,
        );

        // Sincronizar en paralelo para mayor velocidad si son muchas (o secuencial si prefieres)
        const syncPromises = allOrders.map(async (orderId) => {
            try {
                await fetch("/api/admin/sync-status", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ orderId }),
                });
            } catch (e) {
                console.error("Error syncing", orderId, e);
            }
        });

        await Promise.all(syncPromises);

        if (syncAllBtn && !isAuto) {
            syncAllBtn.innerHTML = originalText;
            syncAllBtn.disabled = false;
        }

        if (statusText) {
            statusText.textContent = `Última: ${new Date().toLocaleTimeString("es-PE", { timeZone: "America/Lima" })}`;
        }

        // Si es manual, recargamos. Si es auto, podríamos decidir no recargar para no molestar,
        // pero para ver los cambios actuales es necesario.
        // Lo ideal sería que el usuario no pierda su scroll.
        if (!isAuto) {
            window.location.reload();
        } else {
            // Recarga para que el usuario vea los cambios reflejados en los contadores (KPIs)
            console.log("Auto-sync completado. Recargando...");
            window.location.reload();
        }
    }

    const syncAllBtn = document.getElementById("sync-all-btn");
    if (syncAllBtn) {
        syncAllBtn.addEventListener("click", () => syncAllTransactions(false));
    }

    // Intervalo de Auto-Sync (cada 3 minutos)
    setInterval(
        () => {
            syncAllTransactions(true);
        },
        3 * 60 * 1000,
    );

    // 🗑️ Eliminar Transacción
    document.querySelectorAll(".delete-tx-btn").forEach((btn) => {
        btn.addEventListener("click", async () => {
            const orderId = btn.dataset.orderId;
            if (
                !confirm(
                    `¿Estás seguro de que deseas eliminar la transacción ${orderId}? Esta acción no se puede deshacer.`,
                )
            ) {
                return;
            }

            try {
                btn.disabled = true;
                const response = await fetch("/api/admin/delete-transaction", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ orderId }),
                });

                if (response.ok) {
                    window.location.reload();
                } else {
                    const data = await response.json();
                    alert(
                        `Error: ${data.error || "No se pudo eliminar la transacción"}`,
                    );
                    btn.disabled = false;
                }
            } catch (err) {
                console.error("Delete error:", err);
                alert("Error de red al intentar eliminar");
                btn.disabled = false;
            }
        });
    });

    const logoutBtn = document.getElementById("logout-btn");

    // 📝 Gestión de Reclamaciones
    const complaintBtns = document.querySelectorAll(".complaint-status-btn");
    complaintBtns.forEach((btn) => {
        btn.addEventListener("click", async () => {
            const id = btn.dataset.id;
            if (!confirm("¿Deseas marcar esta reclamación como ATENDIDA?"))
                return;

            try {
                const response = await fetch("/api/admin/complaints", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ id, status: "ATENDIDO" }),
                });
                if (response.ok) window.location.reload();
                else throw new Error();
            } catch (err) {
                alert("Error al actualizar el estado de la reclamación");
            }
        });
    });

    // 🗑️ Eliminar Reclamación
    document.querySelectorAll(".delete-complaint-btn").forEach((btn) => {
        btn.addEventListener("click", async () => {
            const id = btn.dataset.id;
            if (
                !confirm(
                    "¿Seguro que deseas eliminar esta reclamación? Esta acción es permanente.",
                )
            )
                return;

            try {
                btn.disabled = true;
                const response = await fetch("/api/admin/complaints", {
                    method: "DELETE",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ id }),
                });

                if (response.ok) {
                    window.location.reload();
                } else {
                    const data = await response.json();
                    alert(
                        `Error: ${data.error || "No se pudo eliminar la reclamación"}`,
                    );
                    btn.disabled = false;
                }
            } catch (err) {
                console.error("Delete complaint error:", err);
                alert("Error de red al intentar eliminar");
                btn.disabled = false;
            }
        });
    });

    if (logoutBtn) {
        logoutBtn.addEventListener("click", async () => {
            await fetch("/api/logout", { method: "POST" });
            window.location.href = "/login";
        });
    }
</script>

<style is:global>
    @import url("https://fonts.googleapis.com/css2?family=Inter:wght@100;200;300;400;500;600;700;800;900&display=swap");

    html,
    body,
    h1,
    h2,
    h3,
    h4,
    h5,
    h6 {
        font-family: "Inter", sans-serif !important;
    }

    body {
        -webkit-font-smoothing: antialiased;
        background: #fdfbf9;
    }

    ::-webkit-scrollbar {
        width: 5px;
        height: 5px;
    }
    ::-webkit-scrollbar-thumb {
        background: #e2e8f0;
        border-radius: 10px;
    }

    select {
        background-image: none !important;
    }
</style>
